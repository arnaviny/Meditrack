<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Capture with Tesseract.js</title>
    <style>
       /* עיצוב כללי */
body, html {
    margin: 0;
    padding: 0;
    height: 100%;
    display: flex;
    flex-direction: column;
    background-color: #000;
}

/* מיכל מצלמה */
#camera-container {
    position: relative;
    width: 100%;
    height: 100%;
    overflow: hidden;
}

/* וידאו */
video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
}

video, canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}


/* כפתור צילום */
#capture-button {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 70px;
    height: 70px;
    background-color: #ff3b30;
    border: none;
    border-radius: 50%;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    color: white;
    font-size: 30px;
    text-align: center;
    line-height: 70px;
    cursor: pointer;
    z-index: 10;
    transition: transform 0.2s, box-shadow 0.2s;
}

#capture-button:active {
    transform: scale(1.2);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
}

/* מלבן שקוף */
#focus-box {
    position: absolute;
    top: 45%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 70%;
    height: 57%;
    border: 2px solid white;
    box-shadow: 0 0 10px 267px rgb(0 0 0 / 56%);
    z-index: 3;
    pointer-events: none;
}
#result-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: white;
    background-color: rgba(0, 0, 0, 0.8);
}

#result-container p {
    font-size: 20px;
    margin: 10px 0;
}

#result-container button {
    margin: 10px;
    padding: 10px 20px;
    font-size: 16px;
    background-color: #57e772;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

    </style>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@v2.1.4/dist/tesseract.min.js"></script>
</head>
<body>
    <div id="camera-container">
        <div id="overlay">
            <div id="focus-box"></div>
        </div>
        <video id="video" autoplay playsinline></video>
        <button id="capture-button"></button>
        <canvas id="canvas" style="display:none;"></canvas>
    </div>

    <div id="result-container" style="display:none;">
        <p id="recognized-name"></p>
        <p id="recognized-id"></p>
        <button id="retry-button">Retry</button>
        <button id="save-button">Save</button>
    </div>

    <script>
        const video = document.getElementById('video');
const captureButton = document.getElementById('capture-button');
const canvas = document.getElementById('canvas');
const context = canvas.getContext('2d');
const resultContainer = document.getElementById('result-container');
const recognizedName = document.getElementById('recognized-name');
const recognizedID = document.getElementById('recognized-id');
const retryButton = document.getElementById('retry-button');
const saveButton = document.getElementById('save-button');

let stream = null;

// הפעלת מצלמה
navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(videoStream => {
        stream = videoStream;
        video.srcObject = stream;
    })
    .catch(err => {
        console.error("Error accessing the camera:", err);
        alert("לא ניתן לגשת למצלמה. בדוק הרשאות.");
    });

// קליטת תמונה בלחיצה על הכפתור
captureButton.addEventListener('click', () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0, canvas.width, canvas.height);

    function preprocessImage(canvas) {
    const ctx = canvas.getContext('2d');
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

    // הפיכת התמונה לגווני אפור
    for (let i = 0; i < imageData.data.length; i += 4) {
        const avg = (imageData.data[i] + imageData.data[i + 1] + imageData.data[i + 2]) / 3;
        imageData.data[i] = avg; // אדום
        imageData.data[i + 1] = avg; // ירוק
        imageData.data[i + 2] = avg; // כחול
    }

    ctx.putImageData(imageData, 0, 0);
}

    // מציג את התמונה שצולמה
    video.style.display = 'none'; // הסתרת הווידאו
    canvas.style.display = 'block'; // הצגת התמונה

    // עיבוד עם Tesseract.js
    const image = canvas.toDataURL('image/jpeg');
    captureButton.disabled = true; // מניעת לחיצה נוספת עד סיום העיבוד
    captureButton.textContent = "Processing..."; // שינוי טקסט הכפתור

    Tesseract.recognize(
        image,
        'heb', // תחליף ל-'heb' אם אתה מזהה בעברית
        { logger: info => console.log(info) }
    ).then(({ data: { text } }) => {
        // מציאת שם ומספר אישי
        const lines = text.split('\n');
        const name = lines.find(line => line.match(/[\u0590-\u05FF\s]+/)) || "Unknown Name"; // תמיכה בעברית
        const id = lines.find(line => line.match(/^\d{7,10}$/)) || "Unknown ID"; // מספר ת"ז


        recognizedName.textContent = `Name: ${name}`;
        recognizedID.textContent = `ID: ${id}`;

        // מעבר לתוצאות
        canvas.style.display = 'none'; // הסתרת התמונה
        resultContainer.style.display = 'flex'; // הצגת התוצאה
    }).catch(err => {
        console.error("Error during OCR:", err);
        alert("שגיאה בזיהוי התמונה.");
        captureButton.disabled = false; // הפעלת הכפתור מחדש
        captureButton.textContent = "📸"; // שחזור הטקסט המקורי בכפתור
    });
});

// כפתור "צלם מחדש"
retryButton.addEventListener('click', () => {
    location.reload(); // טוען מחדש את הדף
});

// כפתור "שמור"
saveButton.addEventListener('click', () => {
    const nameAndID = {
        name: recognizedName.textContent.replace("Name: ", ""),
        ID: recognizedID.textContent.replace("ID: ", "")
    };
    console.log("Saved Data:", nameAndID);

    // חזרה לדף הקודם עם הנתונים
    history.back(); // מחזיר את המשתמש לדף הקודם
});
    </script>
</body>
</html>

